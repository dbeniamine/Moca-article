\begin{tikzpicture}[node distance = 2cm,scale=0.8]
    % Node placement
    \begin{pgfonlayer}{foreground}
        \node [Chunk] (ch3)                   {Chunk3 ready};
        \node [right=3em of ch3] (inv1) {};
        \node [Chunk,below=.5em of ch3] (ch2) {Chunk2 current};
        \node [Chunk,below=.5em of ch2] (ch1) {Chunk1 ending};
        \node [Chunk,below=.5em of ch1] (ch0) {Chunk0 finished};
        \node [Chunk,below=5em of inv1] (cur) {current};

        \draw [line,->] (cur.north) |- (ch2.east);
    \end{pgfonlayer}

    \node [fit=(cur) (ch0) (ch1) (ch2) (ch3),filled box=dtcolor,
    header={Trace (Task\#N)}{dtcolor!50}] (Tr) {};

    \node [data,right=2.5em of Tr] (PfL)   {False Page fault map};
    \node [data,right=2.5em of PfL]    (TL)    {Tasks map};


    \node[handler,below=1em of Tr] (Flh) {Read callback};
    \node[handlerI,right=4.5em of Flh] (Inv0) {};
    \node[handler,right=4.5em of Inv0] (PfH) {page fault handler};


    \node[entity,log,below of=Flh] (F) {Logging Process (userspace)};
    \node[entity,mon,right=1.5em of F] (M) {Monitor thread (kernel)};


    \begin{pgfonlayer}{background}
        \node[fit=(F) (M) (cur) (Flh) (PfH) (Tr) (PfL)(TL),header={Moca}{white},basic box] (Moca) {};
    \end{pgfonlayer}

    \node[entity,pf,below right=5em and 4em of M] (T) {Tasks\\(user/kernel\\thread/process)};

    \node [dataL, below left=2em and 1em of T]    (pgt)      {Page table (kernel)};
    \node [dataL, left of=pgt] (proc)     {/proc file (kernel)};
    \node [dataL, left of=proc]   (file)     {File (userspace)};

    \begin{pgfonlayer}{background}
        \node[fit=(file) (proc) (pgt) (T),header={Linux}{white} ,basic box=red,
        %below=1.5em of Moca
    ] (Linux) {};
    \end{pgfonlayer}

    % Edges

    %% Loging process
    %\draw [line,bend right=45] (F.south) -- node {read} (proc.north);
    \path[logA] (F.south) edge[in=150,out=270] node[right] {read} (proc.west);
    \path[logA] (proc.north) edge[in=320,out=120]  node[pos=.8,left] {triggers}
    (Flh.east);
    \path[logA] (Flh.north) edge[out=90,in=270] node[pos=.1,left] {read write} (ch0.south);

    \path[logA] (Flh.west) edge[in=100,out=250] node[pos=.2,right] {write} (file.north);

    % Page faults
    \path[pfA] (T.north)   edge[out=80,in=280] node[pos=.3,left] {triggers} (PfH.east);

    \node[above=1em of PfL] (inv2) {};
    \path[pfAI] (PfH.north) edge[out=140,in=345]  (inv2.east);
    \path[pfA] (inv2.east) edge[out=165,in=20] node[pos=.1,above] {write} (ch2.east);

    \path[pfA] (PfH.north) edge node[right] {read \\ (might \\ write)} (TL.south);
    \path[pfA] (PfH.north) edge[out=140,in=310] node[pos=.3,below=.3em] {read} (PfL.south);
    \path[pfA] (PfH.south)  edge[out=220,in=70] node[pos=.1,left=.5em] {read\\write} (pgt.north);

    %Monitor
    \path[monA] (M.north) edge[out=70,in=290] node[pos=.3,right] {write} (PfL.south);
    \path[monA] (M.north) edge[out=90,in=350] node[pos=.6,left] {write} (cur.east);
    \path[monA] (M.east)  edge[out=340,in=160] node[pos=.6,left] {write} (pgt.west);
    \path[monA] (M.north) edge[out=150,in=300] node[pos=.3,right] {read} (ch1.east);
\end{tikzpicture}

