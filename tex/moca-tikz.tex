\begin{tikzpicture}[scale=.75, each node/.style={minimum width=1em}]
    % Node placement
    \begin{pgfonlayer}{foreground}
        \node [Chunk] (ch3) at (0,0)        {Chunk3 ready};
        \node [Chunk] (ch2) at (0,-1)       {Chunk2 current};
        \node [Chunk] (ch1) at (0,-2)       {Chunk1 ending};
        \node [Chunk] (ch0) at (0,-3)       {Chunk0 finished};
        \node [Chunk] (cur) at (2.5,-1.5)   {current};

        \draw [line,->] (cur.north) |- (ch2.east);
    \end{pgfonlayer}

    \node [fit=(cur) (ch0) (ch1) (ch2) (ch3),filled box=dtcolor,
    header={Trace (Task\#N)}{dtcolor!50}] (Tr) {};

    \node [data] (PfL) at (5,-1) {False Page fault map};
    \node [data] (TL)  at (8,-1) {Tasks map};


    \node[handler] (Flh) at (1,-6) {Read callback};
    \node[handler] (PfH) at (8,-5) {page fault handler};


    \node[entity,log] (F) at (1,-9) {Logging Process (userspace)};
    \node[entity,mon] (M) at (6,-9) {Monitor thread (kernel)};


    \begin{pgfonlayer}{background}
        \node[fit=(F) (M) (cur) (Flh) (PfH) (Tr) (PfL)(TL),header={Moca}{white},basic box] (Moca) {};
    \end{pgfonlayer}

    \node[entity,text width=5.5em,pf] (T) at (7,-13) {Tasks\\(user/kernel\\thread/process)};

    \node [dataL] (pgt)  at (5,-16)     {Page table (kernel)};
    \node [dataL] (proc) at (2,-16)     {/proc file (kernel)};
    \node [dataL] (file) at (-1,-16)     {File (userspace)};

    \begin{pgfonlayer}{background}
        \node[fit=(file) (proc) (pgt) (T),header={Linux}{white} ,basic box=red,
        %below=1.5em of Moca
    ] (Linux) {};
    \end{pgfonlayer}

    % Edges

    %% Loging process
    \path[logA] (F.south) edge[in=150,out=270] node[right] {read} (proc.west);
    \path[logA] (proc.north) edge[in=-30,out=115]  node[pos=.3,right] {triggers}
    (Flh.east);
    \path[logA] (Flh.north) edge[out=90,in=270] node[pos=.2,left] {read write} (ch0.south);

    \path[logA] (Flh.west) edge[in=100,out=240] node[pos=.1,left] {write} (file.north);

    % Page faults
    \path[pfA] (T.north)   edge[out=70,in=-70] node[pos=.05,right] {triggers} (PfH.south);

    \coordinate (inv) at (5.25,0.5);
    \path[pfAI] (PfH.north) edge[out=145,in=0] (inv);
    \path[pfA]  (inv)     edge[out=180,in=20] node[pos=.1,above] {write} (ch2.east);

    \path[pfA] (PfH.north) edge node[right] {read \\ (write)} (TL.south);
    \path[pfA] (PfH.north) edge[out=160,in=310] node[pos=.6,right] {read} (PfL.south);

    \path[pfA] (PfH.east) edge[out=-60,in=20] node[pos=.3,left] {read\\write} (pgt.east);

    %Monitor
    \path[monA] (M.north) edge[out=70,in=290] node[pos=.2,right] {write} (PfL.south);
    \path[monA] (M.north) edge[out=110,in=-30] node[pos=.6,left] {write} (cur.east);
    \path[monA] (M.south)  edge[out=-130,in=110] node[pos=.8,left] {write} (pgt.north);

    \path[monA] (M.north) edge[out=170,in=-10] node[pos=.2,left] {read} (ch1.east);
\end{tikzpicture}

